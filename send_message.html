<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donor Details</title>
  <style>
    :root {
        --primary-500: #22c55e;
        --primary-600: #16a34a;
        --primary-700: #15803d;
        --primary-light: #dcfce7;
    }
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f0fdf4 0%, var(--primary-light) 100%);
            min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    .donor-profile {
      display: flex;
      gap: 30px;
    }
    .donor-info {
      flex: 2;
    }
    .notify-panel {
      flex: 1;
      border-left: 1px solid #ddd;
      padding-left: 20px;
    }
    .blood-badge {
      display: inline-block;
      background-color: #dc3545;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 18px;
      margin-right: 10px;
    }
    .detail-card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #f9f9f9;
    }
    .detail-item {
      margin-bottom: 15px;
    }
    .detail-label {
      font-weight: bold;
      color: #555;
      display: block;
      margin-bottom: 5px;
    }
    .detail-value {
      background-color: white;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 150px;
      margin-bottom: 15px;
      resize: vertical;
    }
    .send-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s;
    }
    .send-btn:hover {
      background-color: #218838;
    }
    .send-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #007bff;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .donor-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    #status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 24px;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-weight: bold;
    }
    .status-sending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Donor Details</h1>
    
    <div class="donor-profile">
      <div class="donor-info">
        <div class="donor-header">
          <span id="bloodType" class="blood-badge">A+</span>
          <h2 id="donorName">Donor Name</h2>
        </div>
        
        <div class="detail-card">
          <div class="detail-item">
            <span class="detail-label">Age</span>
            <div id="donorAge" class="detail-value">-</div>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Contact Number</span>
            <div id="donorContact" class="detail-value">-</div>
          </div>
          
          <div class="detail-item">
            <span class="detail-label" hidden>Email</span>
            <div id="donorEmail" class="detail-value">-</div>
          </div>
        </div>
        
        <div class="detail-card">
          <div class="detail-item">
            <span class="detail-label">Street</span>
            <div id="donorStreet" class="detail-value">-</div>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">City</span>
            <div id="donorCity" class="detail-value">-</div>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">State</span>
            <div id="donorState" class="detail-value">-</div>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Zip Code</span>
            <div id="donorZip" class="detail-value">-</div>
          </div>
        </div>
        
        <div class="detail-card">
          <div class="detail-item">
            <span class="detail-label">Health Conditions</span>
            <div id="donorHealth" class="detail-value">-</div>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Donation Types</span>
            <div id="donorDonationTypes" class="detail-value">-</div>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Registration Date</span>
            <div id="registrationDate" class="detail-value">-</div>
          </div>
        </div>
        
      </div>
      
      <div class="notify-panel">
        <h3>Send Notification</h3>
        <p>Send an SMS to this donor</p>
        
        <textarea id="messageInput" placeholder="Enter your urgent message here...">Urgent: We need your blood type at our hospital immediately. Please respond if you can donate.</textarea>
        
        <!-- AI Message Recommendations -->
        <div id="messageRecommendations" style="margin-top: 15px; margin-bottom: 15px; background-color: #f0f9ff; border-radius: 8px; padding: 12px; border: 1px solid #bfdbfe;">
          <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0284c7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="14.31" y1="8" x2="20.05" y2="17.94"></line>
              <line x1="9.69" y1="8" x2="21.17" y2="8"></line>
              <line x1="7.38" y1="12" x2="13.12" y2="2.06"></line>
              <line x1="9.69" y1="16" x2="3.95" y2="6.06"></line>
              <line x1="14.31" y1="16" x2="2.83" y2="16"></line>
              <line x1="16.62" y1="12" x2="10.88" y2="21.94"></line>
            </svg>
            <strong style="color: #0284c7;">AI Message Recommendations</strong>
          </div>
          <div id="recommendationsList" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
        
        <button id="sendSMSBtn" class="send-btn">Send Urgent SMS</button>
      </div>
    </div>
    
    <a href="patientsForm.html" class="back-link">← Back to Donors List</a>
  </div>

  <!-- Status notification element -->
  <div id="status"></div>
  
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  
  <script>
    // Initialize EmailJS
    (function() {
      emailjs.init('yCWU4AkltHj8zi78b'); // Replace with your actual User ID
    })();

    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const donorId = urlParams.get('id');
      const debugInfo = document.getElementById('debug-info');
      const statusDiv = document.getElementById('status');
      const sendBtn = document.getElementById('sendSMSBtn');
      
      // Get patient details from URL
      const patientBloodType = urlParams.get('bloodType') || '';
      const unitsNeeded = urlParams.get('unitsNeeded') || '';
      const urgencyLevel = urlParams.get('urgency') || '';
      const bloodProduct = urlParams.get('bloodProduct') || '';
      const messageInput = document.getElementById('messageInput');
      
      // Get hospital info
      const hospitalId = sessionStorage.getItem('loggedInHospitalId');
      const hospitals = JSON.parse(localStorage.getItem('hospitals')) || [];
      const hospital = hospitals.find(h => h.id == hospitalId) || { name: 'our hospital', contact: '' };
      
      // Find donor data
      const donors = JSON.parse(localStorage.getItem('donors')) || [];
      const donor = donors.find(d => String(d.id) === String(donorId));
      
      if (donor) {
        // Populate donor details
        document.getElementById('donorName').textContent = donor.name || 'Unknown';
        document.getElementById('bloodType').textContent = donor.bloodGroup || 'Unknown';
        document.getElementById('donorAge').textContent = donor.age || 'Unknown';
        document.getElementById('donorContact').textContent = donor.contact || 'Unknown';
        document.getElementById('donorEmail').textContent = donor.email || 'Unknown';
        
        // Address details
        if (donor.address) {
          document.getElementById('donorStreet').textContent = donor.address.street || 'Unknown';
          document.getElementById('donorCity').textContent = donor.address.city || 'Unknown';
          document.getElementById('donorState').textContent = donor.address.state || 'Unknown';
          document.getElementById('donorZip').textContent = donor.address.zipcode || 'Unknown';
        }
        
        // Health and donation info
        document.getElementById('donorHealth').textContent = donor.healthConditions || 'None provided';
        document.getElementById('donorDonationTypes').textContent = 
          donor.donationTypes ? donor.donationTypes.join(', ') : 'Blood';
        
        // Format registration date
        const regDate = donor.registrationDate ? 
          new Date(donor.registrationDate).toLocaleDateString() : 'Unknown';
        document.getElementById('registrationDate').textContent = regDate;
        
        // Get hospital info for signature
        const hospitalSignature = hospital ? 
          `\n\n— ${hospital.name}\n${hospital.contact}` : '\n\n— LifeLink System';
        
        // Generate AI message recommendations
        generateMessageRecommendations(donor, patientBloodType, unitsNeeded, urgencyLevel, bloodProduct);
        
        // Set default urgent message using patient details if available
        let messageText = '';
        
        if (patientBloodType && unitsNeeded) {
          // Create urgency text
          let urgencyText = '';
          if (urgencyLevel === 'emergency') {
            urgencyText = 'This is an EMERGENCY situation. ';
          } else if (urgencyLevel === 'urgent') {
            urgencyText = 'This is URGENT. ';
          }
          
          // Create blood product text
          const productName = bloodProduct ? 
            (bloodProduct === 'whole' ? 'whole blood' : 
             bloodProduct === 'plasma' ? 'plasma' : 
             bloodProduct === 'platelets' ? 'platelets' : 'blood') : 'blood';
          
          const bloodProductText = unitsNeeded > 1 ? 'units' : 'unit';
          
          // Build the message - use the hospital name if available
          const hospitalName = hospital && hospital.name ? hospital.name : 'our hospital';
          messageText = `URGENT: ${donor.name}, we need ${unitsNeeded} ${bloodProductText} of your ${donor.bloodGroup} blood for ${productName}. ` +
            `${urgencyText}Please respond to this message if you can come to ${hospitalName} as soon as possible.`;
        } else {
          // Fallback message - use the hospital name if available
          const hospitalName = hospital && hospital.name ? hospital.name : 'our hospital';
          messageText = `URGENT: ${donor.name}, we need your ${donor.bloodGroup} blood donation immediately. ` +
            `Please respond to this message if you can come to ${hospitalName} as soon as possible.`;
        }
        
        messageInput.value = messageText;
      }

      // SMS Notification Handler
      sendBtn.addEventListener('click', async function() {
        if (!donor || !donor.contact) {
          showStatus('No contact information available for this donor', 'error');
          return;
        }
        
        const message = document.getElementById('messageInput').value.trim();
        if (!message) {
          showStatus('Please enter a message', 'error');
          return;
        }
        
        // Get hospital signature for SMS
        const hospitalSignature = hospital ? 
          `\n\n— ${hospital.name}\n${hospital.contact}` : '\n\n— LifeLink System';
        
        const fullMessage = message + hospitalSignature;
        
        try {
          // Show sending status
          sendBtn.disabled = true;
          showStatus('Sending urgent notification...', 'sending');
          
          // Send via EmailJS
          const response = await emailjs.send(
            'service_ue2qd91', // Replace with your Service ID
            'template_b9pjy1s', // Replace with your Template ID
            {
              to_email: donor.contact + '@txt.att.net', // Using AT&T SMS gateway
              message: fullMessage
            }
          );
          
          // Show success
          showStatus('Urgent notification sent!', 'success');
          console.log('SMS sent successfully:', response);
          
        } catch (error) {
          // Show error
          showStatus('Failed to send via SMS gateway', 'error');
          console.error('EmailJS error:', error);
          
          // Fallback to native SMS
          try {
            const encodedMessage = encodeURIComponent(fullMessage);
            window.location.href = `sms:${donor.contact}?body=${encodedMessage}`;
          } catch (fallbackError) {
            console.error('Fallback SMS failed:', fallbackError);
            showStatus('Failed to open SMS app', 'error');
          }
        } finally {
          sendBtn.disabled = false;
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 3000);
        }
      });
      
      function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status-${type}`;
        statusDiv.style.display = 'block';
      }
      
      // Generate AI-powered message recommendations
      function generateMessageRecommendations(donor, patientBloodType, unitsNeeded, urgencyLevel, bloodProduct) {
        const recommendationsList = document.getElementById('recommendationsList');
        
        // Clear previous recommendations
        recommendationsList.innerHTML = '';
        
        // Different message templates based on various factors
        const recommendations = [];
        
        // Base on donor-patient compatibility
        const donorBloodType = donor.bloodGroup;
        let compatibilityNote = '';
        
        // Check special compatibility cases
        if (donorBloodType === 'O-') {
          compatibilityNote = 'As a universal donor, your blood can help anyone in need.';
          recommendations.push(`${donor.name}, your O- blood is universally compatible and critically needed right now. Could you donate today?`);
        }
        else if (patientBloodType === 'AB+' && donorBloodType) {
          compatibilityNote = 'The patient is a universal recipient and can receive your blood type.';
          recommendations.push(`${donor.name}, we have an AB+ patient who can receive your ${donorBloodType} blood. Are you available to donate?`);
        }
        else if (isCompatible(donorBloodType, patientBloodType)) {
          compatibilityNote = `Your ${donorBloodType} blood is compatible with the patient's ${patientBloodType} type.`;
          recommendations.push(`${donor.name}, your ${donorBloodType} blood is a direct match for our ${patientBloodType} patient. Could you help by donating today?`);
        }
        
        // Based on urgency level
        if (urgencyLevel === 'emergency') {
          recommendations.push(`EMERGENCY: ${donor.name}, we urgently need your ${donorBloodType} blood donation for a critical patient. Please respond ASAP if you can come in.`);
        }
        
        // Based on units needed
        if (unitsNeeded && parseInt(unitsNeeded) > 1) {
          recommendations.push(`${donor.name}, we need ${unitsNeeded} units of ${patientBloodType || donorBloodType} blood. Your donation would help us reach this goal.`);
        }
        
        // Based on previous donation history
        const donationTypes = donor.donationTypes || ['Blood'];
        if (bloodProduct && donationTypes.some(type => type.toLowerCase().includes(bloodProduct.toLowerCase()))) {
          recommendations.push(`${donor.name}, based on your donation history, could you specifically donate ${bloodProduct} today? We have a patient in need.`);
        }
        
        // If no specific recommendations are generated, add a default one
        if (recommendations.length === 0) {
          recommendations.push(`${donor.name}, we need your ${donorBloodType} blood donation at our hospital. Can you help us today?`);
        }
        
        // Add the recommendations to the UI
        recommendations.forEach(recommendation => {
          const recommendationElement = document.createElement('div');
          recommendationElement.style.padding = '10px';
          recommendationElement.style.backgroundColor = 'white';
          recommendationElement.style.borderRadius = '6px';
          recommendationElement.style.border = '1px solid #e5e7eb';
          recommendationElement.style.cursor = 'pointer';
          recommendationElement.textContent = recommendation;
          
          // Click to use this recommendation
          recommendationElement.addEventListener('click', () => {
            document.getElementById('messageInput').value = recommendation;
          });
          
          recommendationsList.appendChild(recommendationElement);
        });
        
        // Add compatibility note if any
        if (compatibilityNote) {
          const noteElement = document.createElement('div');
          noteElement.style.marginTop = '8px';
          noteElement.style.fontSize = '12px';
          noteElement.style.color = '#0284c7';
          noteElement.textContent = `ℹ️ ${compatibilityNote}`;
          recommendationsList.appendChild(noteElement);
        }
      }
      
      // Helper function to check blood compatibility
      function isCompatible(donorType, patientType) {
        if (!donorType || !patientType) return false;
        
        // Universal donor
        if (donorType === 'O-') return true;
        
        // Universal recipient
        if (patientType === 'AB+') return true;
        
        // Compatibility rules
        const compatibility = {
          'O-': ['O-', 'O+', 'A-', 'A+', 'B-', 'B+', 'AB-', 'AB+'],
          'O+': ['O+', 'A+', 'B+', 'AB+'],
          'A-': ['A-', 'A+', 'AB-', 'AB+'],
          'A+': ['A+', 'AB+'],
          'B-': ['B-', 'B+', 'AB-', 'AB+'],
          'B+': ['B+', 'AB+'],
          'AB-': ['AB-', 'AB+'],
          'AB+': ['AB+']
        };
        
        return compatibility[donorType] && compatibility[donorType].includes(patientType);
      }
    });
  </script>
</body>
</html>